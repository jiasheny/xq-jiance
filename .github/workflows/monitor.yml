name: Snowball Monitor (5-Minute WeCom Check)

on:
  schedule:
    # UTC 1:00-7:00 对应 CST 9:00-15:00，工作日每 5 分钟
    - cron: '*/5 1-7 * * 1-5'
  workflow_dispatch:

jobs:
  monitor_job:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    # ---------------------------------------------
    # >>> 关键修正：添加写入权限 (解决 403 错误) <<<
    permissions:
      contents: write
    # ---------------------------------------------

    steps:
      - name: 1. Checkout Repository
        uses: actions/checkout@v4
        with:
          # 在 Job 级别设置了 permissions，这里可以省略 token 属性，但保留也无妨
          token: ${{ secrets.GITHUB_TOKEN }} 

      - name: 2. Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      - name: 3. Install Dependencies
        run: pip install -r requirements.txt

      - name: 4. Prepare config.ini using Secrets
        run: |
          cat << EOF > config.ini
          [default]
          xq_a_token = ${{ secrets.XQ_A_TOKEN }}
          u = ${{ secrets.U_COOKIE }}
          sct_send_key = ${{ secrets.SCT_KEY }}
          wecom_webhook = ${{ secrets.WECOM_WEBHOOK }}
          xq_id_token =
          xq_r_token =

          [notify_mapping]
          ZH1004909 =
          ZH3540811 =
          ZH3489231 =
          ZH005186 =
          EOF

      - name: 5. Initialize processed_ids.json if missing
        run: |
          if [ ! -f processed_ids.json ]; then
            echo "[]" > processed_ids.json
          fi

      - name: 6. Run Monitor Script
        run: python monitor_ga.py

      - name: 7. Commit updated processed_ids.json
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto: Update processed IDs after monitor run."
          file_pattern: processed_ids.json
